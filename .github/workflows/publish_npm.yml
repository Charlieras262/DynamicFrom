name: Publish NPM (OIDC)

on:
  release:
    types: [published]

permissions:
  id-token: write    # ‚úÖ Necesario para OIDC
  contents: read     # Necesario para leer el c√≥digo fuente

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x]   # Recomendado m√≠nimo para Angular + npm OIDC

    steps:
      # 1Ô∏è‚É£ Clona el repositorio
      - uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configura Node y habilita la autenticaci√≥n OIDC con npm
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          registry-url: 'https://registry.npmjs.org'
          always-auth: true

      # 3Ô∏è‚É£ Instala dependencias y compila la librer√≠a
      - run: npm ci
      - run: npm run build
      - run: npm run copy-assets

      # 4Ô∏è‚É£ Instala jq y actualiza versi√≥n seg√∫n el tag del release
      - name: Install jq
        run: sudo apt-get install jq
      - name: Update version in package.json
        run: |
          VERSION=$(echo "${{ github.event.release.tag_name }}" | sed 's/^v//')
          jq ".version = \"$VERSION\"" dist/mat-dynamic-form/package.json > temp.json && mv temp.json dist/mat-dynamic-form/package.json

      # 5Ô∏è‚É£ Publica a npm usando OIDC (sin token)
      - name: Publish to npm using OIDC
        working-directory: dist/mat-dynamic-form
        run: |
          echo "üöÄ Publicando con OIDC (Trusted Publishing)..."
          npm publish --provenance --access public

      # 6Ô∏è‚É£ Mensaje final
      - name: Success message
        if: success()
        run: echo "‚úÖ Publicaci√≥n completada exitosamente con OIDC."
      - name: Failure message
        if: failure()
        run: echo "‚ùå La publicaci√≥n fall√≥. Revisa los logs para m√°s detalles